# PyPlc Ver3 実装プラン - Claude版

## 📋 **現状システム全体レビュー**

### 🎯 **現在の実装状況**

#### ✅ **完了済み機能**
1. **基盤システム**
   - 15×20グリッドシステム完成
   - 30FPS安定動作
   - PLC標準準拠デバイス体系

2. **入力・表示システム**
   - マウス座標→グリッド座標変換
   - スナップ機能（7.0px閾値）
   - リアルタイムステータス表示

3. **デバイス管理システム**
   - A接点配置・削除（左クリック）
   - A接点状態切り替え（右クリック）
   - 自動接続管理

4. **回路解析エンジン**
   - 電力フロー計算
   - 通電状態管理
   - **修正済み**: 通電状態による色表示分離

#### 🔧 **現在の技術的優位性**
- **座標系統一**: `grid[row][col]` = `[y座標][x座標]`完全統一
- **状態分離**: 論理状態(`state`)と通電状態(`is_energized`)の明確な分離
- **PLC準拠**: 実際のPLC動作と完全一致する通電ロジック
- **デバッグ機能**: T/F文字表示による状態可視化

### 🚧 **現在の制限事項**

#### 技術的制限
1. **デバイス種類**: A接点のみ実装（B接点、コイル未実装）
2. **配線システム**: LINK_SIDE等の配線デバイス未実装
3. **複雑回路**: 並列回路、分岐・合流未対応
4. **高度機能**: タイマー・カウンター未実装

#### UI/UX制限
1. **デバイスパレット**: 現在A接点固定（選択機能なし）
2. **視覚的表現**: 仮の四角形描画（PLC標準シンボル未実装）
3. **情報表示**: アドレス表示、デバイス詳細情報なし

## 📋 **次期実装プラン**

### **Phase 2A: デバイス拡張 (優先度: 高)**
```
目標: PLC基本デバイス完全実装
期間: 2-3実装セッション
```

**実装項目**:
1. **B接点実装**
   - DeviceType.CONTACT_B対応
   - 反転ロジック実装
   - 視覚的区別（記号表示）

2. **コイル系実装**
   - DeviceType.COIL（通常コイル）
   - DeviceType.COIL_REV（反転コイル）
   - 出力結果表現ロジック

3. **デバイスパレット実装**
   - 1-4キー: デバイス選択
   - 現在選択デバイス表示
   - デバイス切り替えUI

**技術要件**:
- `_is_conductive()`メソッド拡張
- 描画ロジック分岐追加
- キーボード入力ハンドリング

### **Phase 2B: 配線システム (優先度: 中)**
```
目標: 明示的配線システム実装
期間: 3-4実装セッション
```

**実装項目**:
1. **水平配線 (LINK_SIDE)**
   - 自己保持回路対応
   - 水平電力伝播

2. **垂直配線システム**
   - LINK_TO_UP（上への分岐）
   - LINK_FROM_DOWN（下からの合流）
   - 並列回路対応

3. **複雑回路対応**
   - 分岐・合流ロジック
   - 並列電力計算

**技術要件**:
- `_trace_power_flow()`メソッド拡張
- 並列回路解析アルゴリズム
- 複雑接続管理

### **Phase 2C: UI/UX改善 (優先度: 中)**
```
目標: 実用的なユーザーインターフェース
期間: 2-3実装セッション
```

**実装項目**:
1. **PLC標準シンボル描画**
   - A接点: `|-|`, B接点: `|/|`
   - コイル: `( )`, 反転コイル: `(/)`
   - 配線: 適切な線描画

2. **情報表示システム**
   - デバイスアドレス表示
   - ホバー時詳細情報
   - 回路統計情報

3. **操作性向上**
   - 右クリックメニュー
   - キーボードショートカット
   - Undo/Redo機能

### **Phase 3: 高度機能 (優先度: 低)**
```
目標: 実用PLCレベル機能
期間: 4-5実装セッション
```

**実装項目**:
1. **タイマー・カウンター**
2. **ファイル保存・読込**
3. **回路検証機能**
4. **シミュレーション制御**

## 🎯 **推奨実装順序**

### **第1優先: Phase 2A (デバイス拡張)**
**理由**: 
- 現在のA接点実装が完璧な基盤
- B接点・コイル追加は比較的低リスク
- ユーザー体験の大幅改善

**期待効果**:
- 基本的なPLC回路作成可能
- 教育効果の大幅向上
- システム完成度向上

### **第2優先: Phase 2C (UI改善)**
**理由**:
- 視覚的わかりやすさ向上
- 実用性大幅向上
- デモンストレーション価値向上

### **第3優先: Phase 2B (配線システム)**
**理由**:
- 技術的複雑性が高い
- Phase 2A完了後に実装すべき
- 自己保持回路等の高度機能に必要

## ⚠️ **実装時の注意点**

### **技術的注意事項**
1. **座標系維持**: 現在の`grid[row][col]`統一を絶対に維持
2. **状態分離維持**: `state`と`is_energized`の分離を継続
3. **回路解析エンジン**: 既存の`CircuitAnalyzer`を拡張、置換しない

### **品質保証**
1. **段階的実装**: 一度に複数機能実装しない
2. **動作確認**: 各段階での動作テスト必須
3. **後方互換性**: 既存A接点機能を破壊しない

## 📊 **詳細実装ロードマップ**

### **Phase 2A-1: B接点実装**
**実装ファイル**: 
- `core/circuit_analyzer.py`: `_is_conductive()`メソッド拡張
- `core/grid_system.py`: 描画ロジック追加
- `main.py`: B接点配置ロジック

**実装内容**:
```python
# circuit_analyzer.py 追加予定
if device.device_type == DeviceType.CONTACT_B:
    return not device.state  # OFF状態なら通す（A接点の逆）
```

### **Phase 2A-2: コイル系実装**
**実装ファイル**:
- `core/circuit_analyzer.py`: コイル状態更新ロジック
- `core/grid_system.py`: コイル描画ロジック
- `config.py`: 必要に応じて拡張

### **Phase 2A-3: デバイスパレット**
**実装ファイル**:
- `main.py`: キーボード入力処理
- 新規ファイル可能性: `ui/device_palette.py`

## 🎯 **成功基準**

### **Phase 2A完了基準**
- [ ] A接点・B接点・通常コイル・反転コイルの4種類が動作
- [ ] キーボードでのデバイス選択が機能
- [ ] 基本的なPLC回路（自己保持なし）が正常動作
- [ ] 既存A接点機能が完全に保持されている

### **Phase 2全体完了基準**
- [ ] 自己保持回路が完全動作
- [ ] 並列回路が正常動作
- [ ] PLC標準シンボルで視覚的に理解しやすい
- [ ] 実用的なUI/UX

---

**作成日**: 2025-08-01  
**作成者**: Claude (Anthropic)  
**基準文書**: 現在のVer3実装状況とCLAUDE.md  
**次回更新**: Phase 2A開始時