# データレジスタ実装 Todo リスト

## 実装戦略概要

### 🎯 **実装順序の基本方針**
1. **UI表示システム優先**: スプライトが実装済みなので視覚的確認から開始
2. **段階的統合**: 既存システムへの影響を最小化しながら追加
3. **機能別分離**: データ管理・表示・操作を独立して実装
4. **動作確認重視**: 各ステップで動作確認しながら進行

---

## Phase 1: 基盤・UI実装 (1-2週間)

### 🔧 **Step 1: 基本設定・スプライト統合** 
- [ ] **1.1**: `config.py` に `DeviceType.DATA_REGISTER`, `DeviceType.COMPARE_DEVICE` 追加
- [ ] **1.2**: `main.py` の `_initialize_sprites()` にデータレジスタスプライト追加
  - `D_DEV_ON/OFF`: `sprite_manager.get_sprite_by_name_and_tag("D_DEV", "TRUE/FALSE")`
  - `CMP_ON/OFF`: `sprite_manager.get_sprite_by_name_and_tag("CMP", "TRUE/FALSE")`
- [ ] **1.3**: `main.py` の `_setup_device_palette()` にデバイスパレット項目追加
- [ ] **1.4**: 動作確認: デバイスパレットにデータレジスタ・比較演算子が表示される

### 🎨 **Step 2: GridDevice拡張**
- [ ] **2.1**: `grid_system.py` の `GridDevice` クラスにデータレジスタ専用フィールド追加
  ```python
  # データレジスタ専用フィールド
  self.device_address = ""           # "D100"
  self.current_value = 0             # 現在値
  self.is_32bit = False             # 32ビットフラグ
  
  # 比較演算専用フィールド  
  self.comparison_symbol = "="       # "=", ">", "<", "≥", "≤", "≠"
  self.param_summary = "K100"        # パラメータサマリー
  self.comparison_result = False     # 比較結果
  ```
- [ ] **2.2**: `get_sprite_name()` メソッド追加（状態別スプライト選択）
- [ ] **2.3**: データデバイス初期化処理追加
- [ ] **2.4**: 動作確認: データデバイスの配置・削除が正常動作

### 🖼️ **Step 3: UI表示システム実装**
- [ ] **3.1**: `ui_components.py` に横一列表示ロジック実装
  - `render_data_device()`: データデバイス専用表示メソッド
  - `_calculate_text_width()`: テキスト幅計算
  - `_generate_info_text()`: 情報テキスト生成
- [ ] **3.2**: 右端オフセット自動調整機能実装
- [ ] **3.3**: 状態別色分け表示機能追加
- [ ] **3.4**: `render_grid_devices()` にデータデバイス表示統合
- [ ] **3.5**: 動作確認: データデバイスの視覚表示が正常動作

### 🖱️ **Step 4: マウス操作統合**
- [ ] **4.1**: `mouse_handler.py` (ui_components.py内) にデータデバイス配置処理追加
- [ ] **4.2**: データデバイス選択時のプレビュー表示対応
- [ ] **4.3**: DELキーでのデータデバイス削除対応
- [ ] **4.4**: 動作確認: マウス操作でデータデバイス配置・削除

---

## Phase 2: データ管理・ダイアログ統合 (1週間)

### 💾 **Step 5: データレジスタ管理システム**
- [ ] **5.1**: `plc_logic.py` に `DataRegister` クラス実装
- [ ] **5.2**: `DataRegisterManager` クラス実装（16/32ビット対応）
- [ ] **5.3**: `PLCDevice` クラスにDデバイス対応追加
- [ ] **5.4**: `DeviceManager` にデータレジスタ管理統合
- [ ] **5.5**: 停電保持機能実装（D200-D799）
- [ ] **5.6**: 動作確認: データレジスタの作成・値設定・取得

### 🏗️ **Step 6: ダイアログシステム統合**
- [ ] **6.1**: `dialogs/data_register_config.json` 作成
  - アドレス設定（D100）
  - 初期値設定
  - 32ビットモード選択
- [ ] **6.2**: `dialogs/compare_device_config.json` 作成
  - 比較タイプ選択（=, >, <, ≥, ≤, ≠）
  - 比較値1設定（定数・デバイス）
  - 比較値2設定（デバイス）
- [ ] **6.3**: `main.py` にダイアログ表示処理追加（ENTERキー）
- [ ] **6.4**: ダイアログ→GridDevice反映処理実装
- [ ] **6.5**: 動作確認: ダイアログでデバイス設定が正常動作

### 🔗 **Step 7: 既存システム統合**
- [ ] **7.1**: `electrical_system.py` にデータデバイス認識追加
- [ ] **7.2**: グリッドデバイスとPLCデバイスの同期処理実装
- [ ] **7.3**: F5リセット時のデータデバイス初期化対応
- [ ] **7.4**: デバイス状態表示パネルにデータレジスタ表示追加
- [ ] **7.5**: 動作確認: システム全体の統合動作確認

---

## Phase 3: データ処理ロジック実装 (1-2週間)

### 🧠 **Step 8: DataLogicElement基盤**
- [ ] **8.1**: `plc_logic.py` に `DataLogicElement` 基底クラス実装
  - パルス実行システム
  - 三菱PLC準拠エラーハンドリング（M8020フラグ）
  - 汎用値取得メソッド
- [ ] **8.2**: `LogicElement` から `DataLogicElement` への継承関係構築
- [ ] **8.3**: 動作確認: データ処理基盤の動作確認

### 📊 **Step 9: MOV命令実装**
- [ ] **9.1**: `MOVInstruction` クラス実装（DataLogicElement継承）
- [ ] **9.2**: パルス実行・連続実行の切り替え対応
- [ ] **9.3**: 即値・デバイス参照の統一処理
- [ ] **9.4**: 16ビット・32ビット対応
- [ ] **9.5**: ラダー図統合テスト（X001 → MOV K100 D0 → Y001）
- [ ] **9.6**: 動作確認: MOV命令の基本動作確認

### 🔢 **Step 10: 算術命令実装**
- [ ] **10.1**: `ADDInstruction` クラス実装
- [ ] **10.2**: `SUBInstruction` クラス実装  
- [ ] **10.3**: オーバーフロー検出・例外処理
- [ ] **10.4**: エラーフラグ設定（M8020）との連携
- [ ] **10.5**: ラダー図統合テスト（算術演算回路）
- [ ] **10.6**: 動作確認: 算術命令の動作確認

### ⚖️ **Step 11: 比較命令実装**
- [ ] **11.1**: `CMPInstruction` クラス実装（全比較タイプ対応）
- [ ] **11.2**: GridDeviceの比較デバイスと連動
- [ ] **11.3**: 比較結果の視覚表示（CMP_ON/OFF）
- [ ] **11.4**: ラダー図統合テスト（比較→コイル制御）
- [ ] **11.5**: 動作確認: 比較命令の動作確認

---

## Phase 4: 高度機能・最適化 (1週間)

### 📈 **Step 12: 拡張命令セット**
- [ ] **12.1**: `INCInstruction`（インクリメント）実装
- [ ] **12.2**: `DECInstruction`（デクリメント）実装
- [ ] **12.3**: `MULInstruction`（乗算）実装
- [ ] **12.4**: `DIVInstruction`（除算・ゼロ除算対策）実装
- [ ] **12.5**: 動作確認: 拡張命令の動作確認

### 🎯 **Step 13: UI・UX改善**
- [ ] **13.1**: データレジスタ監視パネル実装
  - 使用中レジスタ一覧表示
  - 値の実時間更新
- [ ] **13.2**: デバッグモード追加
  - レジスタ値変更履歴
  - エラー状態表示
- [ ] **13.3**: パフォーマンス最適化
  - 大量レジスタでの描画最適化
  - メモリ使用量削減
- [ ] **13.4**: 動作確認: UI・UX改善の確認

### 🧪 **Step 14: テスト・品質保証**
- [ ] **14.1**: 単体テスト実装
  - データレジスタ基本操作
  - 各命令の動作確認
  - 境界値テスト
- [ ] **14.2**: 統合テスト実装
  - 複合回路での動作確認
  - タイマー・カウンターとの連携
  - 負荷テスト
- [ ] **14.3**: 回帰テスト実行
  - 既存機能への影響確認
  - パフォーマンステスト
- [ ] **14.4**: ドキュメント更新
  - CLAUDE.md更新
  - 使用マニュアル作成

---

## 実装ガイドライン

### 🔧 **コーディング規約**
- **段階的コミット**: 各Stepごとにコミット
- **動作確認**: 各Step完了時に必ず動作確認
- **既存コード尊重**: 既存の命名規則・構造に従う
- **エラーハンドリング**: 三菱PLC準拠のエラー処理

### ⚠️ **注意事項**
- **既存機能保護**: 既存のX,Y,M,T,Cデバイス機能に影響を与えない
- **パフォーマンス維持**: 60FPSリアルタイム処理を維持
- **メモリ効率**: 疎なデータ構造で実メモリ使用量を最適化
- **三菱PLC準拠**: 実PLC仕様との整合性を重視

### 🎯 **成功基準**
- **基本機能**: データレジスタの読み書き・表示が正常動作
- **命令セット**: MOV・ADD・SUB・CMP命令が正常動作
- **UI統合**: 直感的な設定・操作が可能
- **システム統合**: 既存のラダー図システムとシームレス連携

---

## 参考リソース

### 📚 **設計ドキュメント**
- `_Claude_DataRegister_AddOn_Plan.md`: 詳細設計仕様
- `_WindSurf_DataRegister_AddOn_Plan.md`: 元設計参考
- `CLAUDE.md`: PyPlc全体アーキテクチャ

### 🎨 **実装済みリソース**
- **スプライトデータ**: `D_DEV`, `CMP` (TRUE/FALSE状態対応)
- **PyxDialog**: `pyxdlg.py` モーダルダイアログシステム
- **既存アーキテクチャ**: 3層アーキテクチャ（grid_system, electrical_system, plc_logic）

### 🔍 **デバッグ・テスト**
- **実用例**: 温度監視システム、生産カウンター管理
- **学習リソース**: 電気設計人.com等の実用パターン集
- **エラーパターン**: オーバーフロー・ゼロ除算・境界値

---

**実装開始準備完了**: 2025年1月  
**予定完成**: 2025年2月  
**実装担当**: Claude + Human Developer  
**品質管理**: 段階的動作確認・回帰テストによる品質保証

*このTodoリストに従って段階的に実装することで、安全で確実なデータレジスタシステムの実現を目指します。*