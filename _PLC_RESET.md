# PLC カウンター・タイマーリセット機能調査報告書

**作成日**: 2025-08-08  
**目的**: 世界主要PLCメーカーのリセット機能実装方式調査  
**対象**: PyPlc Ver3への実装検討資料  

---

## 📋 **調査概要**

世界の主要PLCメーカー（三菱電機、シーメンス、Allen Bradley）のカウンター・タイマーリセット機能について、WEB検索による実装方式調査を実施。PyPlc Ver3への最適な実装方針を決定する。

---

## 🏭 **三菱電機（Mitsubishi PLC）**

### **RST命令方式**
```
---| |---[RST C0 ]  ← RST命令でカウンターリセット
      ↑
   リセット接点（例：X010）
```

### **実装特徴**
- **RST命令**: カウンター現在値を0にリセット + 出力接点もOFF復帰
- **ZRST命令**: 複数カウンター・タイマーの一括リセット
- **即座実行**: リセット実行時点で現在値=0、出力も即座復帰
- **汎用性**: Y出力、M補助リレー、T/Cタイマー・カウンターすべて対応

### **対応デバイス範囲**
- **16ビットカウンター**: C0～C199
- **32ビットカウンター**: C200～C255  
- **タイマー**: T0～T255
- **出力・補助リレー**: Y, M全般

### **使用例**
```
# 基本リセット
X001 ──┤├── RST C0    # X001 ON時、C0カウンターリセット

# 複数一括リセット  
X002 ──┤├── ZRST C0 C5  # C0～C5まで一括リセット
```

---

## 🔧 **シーメンス（Siemens PLC）**

### **内蔵リセット端子方式**
```
CTU Counter Block
├─ CU (Count Up入力)
├─ R (Reset入力)      ← 内蔵リセット端子
├─ PV (Preset Value)
└─ Q/CV (Output/Current Value)
```

### **実装特徴**
- **R端子**: カウンターブロック内蔵のリセット入力端子
- **CV値**: リセット時にCV（Current Value）が0にクリア
- **Q出力**: リセット時にQ出力もOFF
- **CTUD対応**: アップ/ダウン両方向カウンター対応

### **実装上の課題**
```
注意: シーメンス実装には技術的課題あり
「多くの人がシーメンスCTU実装について不満」
「R端子が期待通り動作しない場合がある」
→ 代替案: MOV命令で0を直接代入
```

### **代替実装例**
```
# 確実なリセット方法
Reset_Input ──┤├── MOV 0 → Counter.CV
```

---

## ⚡ **Allen Bradley（Rockwell Automation）**

### **RES命令方式**
```
---| |---[CTU C5:0]    ← カウンター定義
         [PRE: 10 ]    
         [ACC:  0 ]

---| |---[RES C5:0]    ← RES命令でリセット
      ↑
   リセット接点
```

### **実装特徴**
- **RES命令**: Counter構造体をリセット（ACC=0）
- **動的変更**: MOV命令でACC/PRE値を実行中に変更可能
- **DINT対応**: ACC/PREは32ビット整数（DINT）
- **柔軟性**: CTU+CTDの組み合わせでCTUD実現

### **高度な機能**
```
# 動的プリセット変更
Input_1 ──┤├── MOV 100 → C5:0.PRE

# 動的現在値変更  
Input_2 ──┤├── MOV 50 → C5:0.ACC
```

---

## 📊 **メーカー別比較表**

| 項目 | 三菱電機 | シーメンス | Allen Bradley |
|-----|---------|------------|---------------|
| **リセット方式** | RST命令 | R端子 | RES命令 |
| **実装信頼性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **学習難易度** | 易 | 中 | 中 |
| **日本シェア** | 高 | 中 | 低 |
| **教育適性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |

---

## 🎯 **PyPlc Ver3への実装推奨**

### **推奨方式: 三菱電機RST命令方式**

**採用理由**:
1. **教育的価値**: 日本で最も普及している三菱PLC準拠
2. **実装シンプルさ**: RST命令1つで直感的操作
3. **実用性**: 工場現場で最も使われる標準的方式
4. **信頼性**: 技術的課題なし、確実な動作保証

### **実装仕様案**

#### **1. DeviceType拡張**
```python
# config.py追加
class DeviceType(Enum):
    # 既存デバイス...
    RST = "RST"  # Reset命令（新規追加）
```

#### **2. デバイスパレット統合**
```python
# デバイスパレット配置（例：下段Shift+3キー）
(DeviceType.RST, "RST", 3, "Reset Command"),
```

#### **3. RST命令動作仕様**
```python
def _process_rst_command(self, rst_device) -> None:
    """
    RST命令処理（三菱PLC準拠）
    通電時に指定アドレスのタイマー・カウンターをリセット
    """
    if rst_device.is_energized and rst_device.address:
        target_address = rst_device.address  # 例: "C0", "T1"
        
        # 指定アドレスのデバイスを検索してリセット
        for row in range(self.grid.rows):
            for col in range(self.grid.cols):
                device = self.grid.get_device(row, col)
                if (device and device.address == target_address and 
                    device.device_type in [DeviceType.TIMER_TON, DeviceType.COUNTER_CTU]):
                    
                    # PLC標準準拠リセット処理
                    device.current_value = 0
                    device.state = False  # 出力もOFF
                    if hasattr(device, 'timer_active'):
                        device.timer_active = False
```

#### **4. 使用例**
```
# カウンター回路
X001 ──┤├── CTU C0   # X001でカウントアップ
             K: 5     # プリセット値5回

# リセット回路  
X002 ──┤├── RST C0   # X002でC0カウンターリセット
```

### **実装優先度**

**Phase 1** (高): RST命令基本実装
- DeviceType.RST追加
- アドレス指定機能
- 基本リセット動作

**Phase 2** (中): 高度機能
- ZRST一括リセット命令
- 範囲指定リセット
- エラー処理強化

**Phase 3** (低): UI改善
- RST対象アドレス候補表示
- リセット実行時の視覚効果
- デバッグ情報表示

---

## 📚 **参考資料**

### **WEB調査ソース**
- 電気設計人.com - 三菱PLC RST命令解説
- PLCS.net - シーメンス・Allen Bradley技術フォーラム
- シーケンス制御の部屋 - PLC教育サイト
- 各メーカー公式技術資料

### **技術的注意点**
1. **スキャン周期**: RST実行タイミングの考慮必要
2. **アドレス検証**: 存在しないアドレス指定時のエラー処理
3. **同時リセット**: 複数RST命令の競合回避
4. **状態保存**: CSV保存時のRST状態考慮

---

## 💡 **今後の学習課題**

### **実装技術**
- [ ] RST命令の回路解析統合方法
- [ ] アドレス解決アルゴリズム最適化
- [ ] UI/UXデザイン（RST専用アイコン等）

### **PLC知識**
- [ ] 各メーカーのタイマー・カウンター詳細仕様
- [ ] 産業用制御システムでのリセット活用例
- [ ] 実機との動作比較検証

### **教育価値**
- [ ] 初学者向けRST命令学習コンテンツ
- [ ] 実践的な回路例集作成
- [ ] トラブルシューティングガイド

---

**この調査資料により、PyPlc Ver3に最適なリセット機能実装方針が確定しました。**  
**実装時は三菱電機RST命令方式を採用し、教育的価値と実用性を両立します。**

*最終更新: 2025-08-08*  
*次回更新: RST命令実装完了時*