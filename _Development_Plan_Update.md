# Ver3開発プラン更新版

**作成日**: 2025-08-03  
**基準文書**: `_Ver3_Definition.md` vs 現在の実装状況  
**目的**: 以後の開発プランとして最新化

---

## 📊 **定義書 vs 実装状況の比較分析**

### ✅ **完全実装済み（定義書準拠）**

#### **1. PLC標準準拠の基本概念**
- **INCOIL/OUTCOIL概念の完全廃止** ✅
- **CONTACT/COIL概念の正確な実装** ✅
- **座標系の完全統一** `grid[row][col]` # [y座標][x座標] ✅

#### **2. 明示的配線システム**
- **LINK_HORZ（水平配線）の実装** ✅
- **自己保持回路の正確な動作** ✅（今日の並列回路合流ロジック完成により）
- **電気的継続性の完全トレース** ✅

#### **3. Ver2資産の有効活用**
- **モジュール化アーキテクチャ継承** ✅
- **グリッドベース座標系継承** ✅
- **リアルタイム電力フロー可視化** ✅
- **マウス操作システム継承** ✅

---

## 🔄 **実装アプローチの重要な変更**

### **定義書の提案 vs 実際の選択**

#### **1. 実装戦略の選択**
```python
# 定義書: 2つのアプローチを提示
recommended = "段階的リファクタリング"  # 推奨案
alternative = "ゼロからクリーン実装"    # 代案

# 実際の選択: ゼロからクリーン実装を採用
actual_choice = "ゼロからクリーン実装"
reasons = [
    "PLC標準仕様の完全準拠確保",
    "技術的負債の完全解消",
    "Ver3設計思想の純粋実装",
    "長期的保守性の向上"
]
```

#### **2. パフォーマンス設定の変更**
```python
# 定義書の仕様
definition_spec = {
    "TARGET_FPS": 60,
    "focus": "高性能"
}

# 実際の実装
actual_spec = {
    "TARGET_FPS": 30,
    "focus": "安定性・教育用途最適化"
}
```

---

## 🏗️ **モジュール構造の進化**

### **定義書で提案された構造**
```python
# Ver3で改良・追加予定だったモジュール
core/
├── device_factory.py     # 🆕 デバイス生成ファクトリー
├── circuit_analyzer.py   # 🆕 回路解析エンジン ✅実装済み
├── connection_manager.py # 🆕 明示的配線管理 🚧未実装
└── plc_standard.py       # 🆕 PLC標準仕様準拠チェック 🚧未実装
```

### **実際に実装された構造**
```python
# 実際のVer3モジュール構造
core/
├── grid_system.py          # グリッド管理（Ver2改良版）
├── input_handler.py        # 入力処理（Ver2改良版）
├── circuit_analyzer.py     # 回路解析エンジン ✅
├── device_base.py         # デバイス基底クラス（新規）
├── device_palette.py      # デバイス選択（Ver2改良版）
└── SpriteManager.py       # スプライト管理（新規）
```

### **評価と今後の方針**
- **実装された構造**: 実用性と保守性を重視した最適化
- **未実装の提案**: 将来の拡張機能として段階的実装予定

---

## 📋 **未実装機能の優先順位付け**

### **優先度：最高（PLC基本機能）**

#### **1. タイマー・カウンターデバイス**
```python
# 定義書の仕様（Ver2継承予定）
timer_spec = {
    "states": ["STANDBY", "CNTUP", "ON"],  # 3状態システム
    "inheritance": "Ver2の成功パターン活用",
    "priority": "PLC基本機能として必須"
}

counter_spec = {
    "detection": "立ち上がりエッジ検出",
    "inheritance": "Ver2の成功パターン活用", 
    "priority": "PLC基本機能として必須"
}
```

#### **2. キー操作マッピングの完全実装**
```python
# 定義書の仕様 vs 現在の実装状況
key_mapping_status = {
    1: "A接点",         # ✅実装済み
    2: "B接点",         # ✅実装済み  
    3: "水平配線",      # ✅実装済み（LINK_HORZ）
    4: "通常コイル",    # ✅実装済み
    5: "反転コイル",    # ✅実装済み
    6: "タイマー",      # 🚧未実装
    7: "カウンター",    # 🚧未実装
    8: "上向き接続",    # ✅実装済み（LINK_FROM_DOWN）
    9: "下向き接続",    # ✅実装済み（LINK_TO_UP）
    0: "削除",          # ✅実装済み
}
```

### **優先度：高（品質向上）**

#### **3. PLC標準仕様準拠チェック機能**
```python
# 定義書で提案された plc_standard.py の実装
plc_compliance_features = [
    "二重コイルエラー検出",      # 同一アドレスのコイルが複数配置
    "未接続コイルの警告",        # 左バスから到達不能なコイル
    "アドレス重複チェック",      # 不正なアドレス設定
    "回路構文エラー検出",        # PLC記法違反の検出
]
```

#### **4. 接続情報自動生成システム**
```python
# 定義書で提案された connection_manager.py の実装
auto_connection_features = [
    "デバイス配置時の自動配線",    # 隣接デバイスとの自動接続
    "配線整合性チェック",          # 接続情報の一貫性確保
    "配線最適化",                  # 不要な配線の自動削除
    "配線修復機能",                # 破損した配線の自動修復
]
```

### **優先度：中（実用性向上）**

#### **5. データ保存・読み込み機能**
```python
# 定義書では明示されていないが実用性のために必要
data_persistence = {
    "file_format": "JSON または独自形式",
    "save_targets": [
        "回路図データ",
        "デバイス設定", 
        "アドレス情報",
        "接続情報"
    ],
    "features": [
        "プロジェクト管理",
        "バージョン管理",
        "エクスポート機能"
    ]
}
```

---

## 🎯 **開発思想の進化点**

### **GEMINI提案の積極採用**

#### **1. データ構造設計**
```python
# 定義書: 基本概念のみ提示
# GEMINI: 具体的な実装設計を提案・採用済み
@dataclass
class PLCDevice:
    device_type: DeviceType
    position: Tuple[int, int]
    address: str  
    state: bool = False
    is_energized: bool = False
    connections: Dict[str, Optional[Tuple[int, int]]] = field(default_factory=dict)
```

#### **2. 垂直リンクの命名改良**
```python
# 定義書: Ver2継承予定
original_naming = {
    "LINK_UP": "上向き接続",
    "LINK_DOWN": "下向き接続"
}

# GEMINI提案・実際採用
improved_naming = {
    "LINK_FROM_DOWN": "下の行からの論理を受け取る合流点",
    "LINK_TO_UP": "上の行へ論理を送る分岐点"
}
```

#### **3. 並列回路解析の詳細設計**
```python
# 定義書: 概念的説明のみ
# GEMINI: 具体的なアルゴリズム設計・実装完了
def _handle_parallel_convergence(self, device, visited):
    """並列回路の合流ロジック（GEMINI設計・実装済み）"""
    # 下の行からの電力供給検出
    # 合流点での論理OR動作
    # 正確な通電状態計算
```

---

## 📅 **更新された開発ロードマップ**

### **Phase 5: 基本機能完成（次期最優先）**
**期間**: 2025-08-03 〜 2025-08-10  
**目標**: PLC基本デバイスの完全実装

- [ ] **タイマーデバイス実装**
  - 3状態システム（STANDBY/CNTUP/ON）
  - Ver2の成功パターン活用
  - スプライト・UI統合

- [ ] **カウンターデバイス実装**  
  - エッジ検出システム
  - カウント値管理
  - リセット機能

- [ ] **キー操作の完全対応**
  - 6番キー: タイマー選択
  - 7番キー: カウンター選択

### **Phase 6: 品質向上（中期目標）**
**期間**: 2025-08-10 〜 2025-08-20  
**目標**: プロフェッショナル品質の確保

- [ ] **PLC標準準拠チェック実装**
  - `core/plc_standard.py` 新規作成
  - 二重コイルエラー検出
  - 回路構文エラー検出

- [ ] **接続自動生成システム**
  - `core/connection_manager.py` 新規作成
  - 自動配線機能
  - 配線最適化

### **Phase 7: 実用性向上（長期目標）**
**期間**: 2025-08-20 〜 2025-09-01  
**目標**: 実用レベルの機能完成

- [ ] **データ保存・読み込み**
- [ ] **プロジェクト管理機能**
- [ ] **エクスポート機能**
- [ ] **パフォーマンス最適化**

---

## 🏆 **成功基準の更新**

### **Ver3完成基準（定義書ベース + 実装経験）**

#### **機能的成功** 
- [x] PLC標準準拠の基本概念実装 
- [x] 自己保持回路の完全動作
- [ ] タイマー・カウンター実装 ⬅️ **次の重要マイルストーン**
- [x] 実PLC仕様との基本準拠

#### **品質的成功**
- [x] 30FPS安定動作維持（定義書60FPS→実用最適化）
- [x] メモリリーク解消
- [ ] 1時間以上無故障動作（要長期テスト）

#### **教育的成功**
- [x] PLC概念の正確な実装
- [x] 実PLC移行時の違和感解消
- [ ] PLC教科書レベル回路100%動作（タイマー・カウンター実装後）

---

## 📖 **開発方針の確定**

### **採用方針**
1. **ゼロからクリーン実装**: 継続（成功パターン確立済み）
2. **GEMINI提案積極採用**: 技術的優位性確認済み
3. **30FPS安定動作**: 教育用途最適化として継続
4. **段階的機能追加**: リスク管理重視

### **重要な教訓**
- **定義書は優秀な設計指針**だが、実装過程での進化も重要
- **Ver2資産の選択的活用**が成功の鍵
- **AI支援による段階的開発**が品質確保に有効

---

*最終更新: 2025-08-03*  
*次回更新: タイマー・カウンター実装完了時*  
*参考文書: _Ver3_Definition.md, CLAUDE.md, GEMINI.md, _Common_Report.md*