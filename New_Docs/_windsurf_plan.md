# PyPlc Ver3 縦方向結線アーキテクチャ改修プロジェクト

**プロジェクト開始日**: 2025-08-05  
**ブランチ**: VirtCircuit  
**最終更新**: 2025-08-05 22:05  

---

## 🎯 プロジェクト概要

### **目的**
LINK_TO_UP/LINK_FROM_DOWNの複雑な上下方向概念を、BRANCH_POINT+LINK_VIRT中心のシンプルで直感的なモデルに移行し、実PLC設計思想に準拠した縦方向結線システムを実現する。

### **背景**
- **現状の問題**: LINK_TO_UP→LINK_FROM_DOWNの直接接続が動作しない
- **根本原因**: 上下2方向概念の複雑性、実PLC設計思想との乖離
- **解決方針**: 分岐点(BRANCH_POINT)+垂直配線(LINK_VIRT)による直感的モデル

### **戦略**
段階的移行（新概念実装→併存→検証→旧概念削除）

---

## 🏗️ 新アーキテクチャ設計

### **新概念**
```python
# 新規導入
BRANCH_POINT    # 分岐点（電力を全方向に分配）
LINK_VIRT       # 垂直配線（物理的な縦接続）

# 廃止予定
LINK_TO_UP      # 複雑な上方向伝播
LINK_FROM_DOWN  # 複雑な合流ロジック
```

### **実装例**
```
行1: [接点A] - [BRANCH_POINT] - [接点B] - [コイル]
行2:              [LINK_VIRT]
行3:              [LINK_VIRT]  
行4:              [BRANCH_POINT] - [接点C]
```

### **電力トレースロジック**
```python
def _trace_power_flow(self, device):
    if device.device_type == DeviceType.BRANCH_POINT:
        # 全方向（右・上・下）に電力を分配
        self._trace_power_flow(device.connections.get('right'))
        self._trace_power_flow(device.connections.get('up'))
        self._trace_power_flow(device.connections.get('down'))
    
    elif device.device_type == DeviceType.LINK_VIRT:
        # 縦方向に電力を伝播
        self._trace_power_flow(device.connections.get('up'))
        self._trace_power_flow(device.connections.get('down'))
```

---

## 📅 実装スケジュール

### **Phase 1: 設計レビュー・詳細化（1週間）**
**期間**: 2025-08-05 ～ 2025-08-12  
**目標**: 新アーキテクチャの妥当性確認と実装計画詳細化

#### **作業項目**
- [ ] **AI専門家による設計レビュー**
  - 新アーキテクチャの技術的妥当性検証
  - 実PLC設計思想との整合性確認
  - 潜在的問題点の洗い出し
  - パフォーマンス影響評価

- [ ] **詳細実装計画策定**
  - 各ファイルの修正内容詳細化
  - データ構造・インターフェース設計
  - 移行手順の具体化
  - 依存関係の整理

- [ ] **テスト戦略策定**
  - 包括的テストシナリオ作成
  - 回帰テスト計画
  - バグ防止手法の確立
  - 自動テスト環境の検討

### **Phase 2: 新概念実装（1週間）**
**期間**: 2025-08-12 ～ 2025-08-19  
**目標**: BRANCH_POINTの実装と基本動作確認

#### **作業項目**
- [ ] **config.py修正**
  ```python
  class DeviceType(Enum):
      BRANCH_POINT = "BRANCH_POINT"  # 新規追加
      # 既存のLINK_TO_UP/LINK_FROM_DOWNは保持（併存期間）
  ```

- [ ] **スプライトリソース追加**
  - `sprites.json`にBRANCH_POINT定義追加
  - `my_resource.pyxres`にスプライト画像追加
  - 視覚的識別性の確保（他デバイスとの差別化）

- [ ] **device_palette.py修正**
  - BRANCH_POINT選択項目追加
  - UI表示の調整
  - ツールチップ・説明文の追加

- [ ] **基本配置機能実装**
  - グリッドへのBRANCH_POINT配置
  - 接続情報の管理
  - 基本的な描画機能

### **Phase 3: 電力トレースロジック実装（1週間）**
**期間**: 2025-08-19 ～ 2025-08-26  
**目標**: 新しい電力伝播ロジックの実装

#### **作業項目**
- [ ] **circuit_analyzer.py修正**
  - BRANCH_POINT用電力トレースロジック実装
  - 既存ロジックとの併存
  - 無限ループ防止機構の確保
  - パフォーマンス最適化

- [ ] **新テストケース作成**
  - `test_branch_point_basic.csv`: 基本分岐テスト
  - `test_branch_point_multi.csv`: 複数行跨ぎテスト
  - `test_branch_point_complex.csv`: 複雑な並列回路テスト
  - `test_branch_point_performance.csv`: 性能テスト用

- [ ] **動作検証**
  - 新旧システム併存での動作確認
  - 既存機能への影響確認
  - 30FPS安定動作の維持確認

### **Phase 4: 段階的移行（1週間）**
**期間**: 2025-08-26 ～ 2025-09-02  
**目標**: 旧システムから新システムへの完全移行

#### **作業項目**
- [ ] **既存テストケース書き換え**
  - `test_link_direct.csv` → BRANCH_POINT使用版
  - `test_link_virt_1row.csv` → BRANCH_POINT使用版
  - `test_link_virt_2row.csv` → BRANCH_POINT使用版

- [ ] **旧概念の段階的削除**
  - LINK_TO_UP/LINK_FROM_DOWNの処理ロジック削除
  - 関連コードのクリーンアップ
  - デバイスパレットからの削除
  - ドキュメントの更新

- [ ] **最終検証**
  - 全機能の動作確認
  - 性能テスト（30FPS維持確認）
  - 回帰テストの実行
  - ユーザビリティテスト

---

## 📁 影響ファイル一覧

### **🔧 修正必須ファイル**
```
core/
├── circuit_analyzer.py     # 電力トレースロジック全面書き換え
│   ├── _trace_power_flow()         # BRANCH_POINT対応
│   ├── _handle_parallel_convergence() # 簡素化
│   └── solve_ladder()              # 統合テスト
├── device_palette.py       # BRANCH_POINT追加、旧概念削除
│   ├── デバイス選択項目更新
│   ├── UI表示調整
│   └── ツールチップ追加
└── grid_system.py          # 接続管理ロジック調整
    ├── 接続情報管理
    ├── デバイス配置処理
    └── 状態管理

config.py                   # DeviceType定義変更
├── BRANCH_POINT追加
└── 旧概念の段階的削除

sprites.json               # BRANCH_POINTスプライト定義
├── スプライト座標定義
├── アニメーション設定
└── 表示属性

my_resource.pyxres         # スプライト画像リソース
├── BRANCH_POINT画像追加
└── 視覚的識別性確保
```

### **📝 テストファイル**
```
# 新規作成
test_branch_point_basic.csv      # 基本分岐テスト
test_branch_point_multi.csv      # 複数行跨ぎテスト  
test_branch_point_complex.csv    # 複雑な並列回路テスト
test_branch_point_performance.csv # 性能テスト

# 書き換え対象
test_link_direct.csv            # BRANCH_POINT版に書き換え
test_link_virt_1row.csv         # BRANCH_POINT版に書き換え
test_link_virt_2row.csv         # BRANCH_POINT版に書き換え
```

---

## ⚠️ リスク管理

### **高リスク項目**
| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|----------|--------|
| 既存並列回路の一時的破綻 | 高 | 中 | 段階的移行、バックアップブランチ |
| 大規模コード変更によるバグ | 高 | 中 | 小単位実装、即座テスト |
| テストケース全面書き直し | 中 | 高 | 自動化ツール、段階的更新 |
| パフォーマンス劣化 | 中 | 低 | 性能テスト、最適化 |

### **リスク軽減策**
- **バックアップ戦略**: 各Phase完了時にコミット
- **段階的テスト**: 各修正後の即座な動作確認
- **ロールバック計画**: 問題発生時の復旧手順準備
- **継続的インテグレーション**: 自動テスト環境の活用

---

## 🎯 成功指標

### **技術的指標**
- [ ] BRANCH_POINT基本動作の確認
- [ ] 複数行跨ぎ接続の正常動作
- [ ] 30FPS安定動作の維持
- [ ] 既存機能への影響なし
- [ ] メモリ使用量の増加なし

### **品質指標**
- [ ] 全テストケースの通過
- [ ] コードの可読性・保守性向上
- [ ] 概念の直感的理解の実現
- [ ] ドキュメントの完全性

### **ユーザビリティ指標**
- [ ] デバイス配置の直感性向上
- [ ] 並列回路作成の簡素化
- [ ] エラーメッセージの分かりやすさ

---

## 📞 AI専門家レビュー要請

### **設計レビュー項目**
1. **BRANCH_POINT概念の妥当性**
   - 実PLC設計との整合性
   - 電気回路理論との一致
   - 教育的価値の評価

2. **電力トレースアルゴリズム**
   - アルゴリズムの効率性
   - 正確性の保証
   - スケーラビリティ

3. **データ構造設計**
   - 拡張性の確保
   - 保守性の向上
   - メモリ効率

4. **移行戦略**
   - リスク最小化手法
   - 段階的実装の妥当性
   - ロールバック戦略

### **実装レビュー項目**
1. **インターフェース設計**
   - モジュール間結合度
   - 依存関係の最適化
   - API設計の一貫性

2. **エラーハンドリング**
   - 例外処理の適切性
   - エラー回復機能
   - ユーザーフィードバック

3. **テスト設計**
   - カバレッジの妥当性
   - シナリオの包括性
   - 自動化の可能性

4. **性能影響**
   - 処理速度の維持
   - メモリ使用量
   - リソース効率

---

## 📈 今後の展開

### **短期目標（1ヶ月）**
- Phase 1-4の完全実装
- 新アーキテクチャの安定化
- ドキュメント整備

### **中期目標（3ヶ月）**
- 高度な並列回路機能の追加
- UI/UXの改善
- 教育機能の強化

### **長期目標（6ヶ月）**
- 産業用途への拡張
- 他PLC機能の実装
- 商用品質の達成

---

## 🔄 関連プロジェクト

### **並行実装検討項目**
1. **Load/Save機能実装**
   - CSV形式でのグリッド情報保存
   - ROW, COL, デバイス情報の構造化
   - 新アーキテクチャとの整合性確保

2. **Edit/Runモード実装**
   - TABキー切り替え機能
   - F5キー実行/停止制御
   - F6キー全システムリセット
   - デバイスパレット表示制御

### **統合計画**
- 縦方向結線改修完了後の機能統合
- 相互影響の最小化
- 統一的なユーザーエクスペリエンス

---

## 📋 チェックリスト

### **Phase 1完了条件**
- [ ] AI専門家レビュー完了
- [ ] 詳細実装計画策定完了
- [ ] テスト戦略確定
- [ ] リスク評価完了

### **Phase 2完了条件**
- [ ] BRANCH_POINT基本実装完了
- [ ] スプライトリソース追加完了
- [ ] デバイスパレット更新完了
- [ ] 基本配置機能動作確認

### **Phase 3完了条件**
- [ ] 電力トレースロジック実装完了
- [ ] 新テストケース作成完了
- [ ] 動作検証完了
- [ ] 性能テスト通過

### **Phase 4完了条件**
- [ ] 既存テストケース書き換え完了
- [ ] 旧概念削除完了
- [ ] 最終検証完了
- [ ] ドキュメント更新完了

---

## 📚 参考資料

### **設計ドキュメント**
- `_Common_Report.md`: 課題分析・改修提案
- `EditandRunMode.md`: 関連機能仕様
- `_Ver3_Definition.md`: システム全体仕様

### **技術資料**
- 実PLC設計資料
- 電気回路理論
- ソフトウェアアーキテクチャパターン

### **開発履歴**
- Git履歴: VirtCircuitブランチ
- 過去の実装セッション記録
- 第三者評価レポート

---

**このプランは、PyPlc Ver3の縦方向結線システムを根本的に改善し、実PLC設計思想に準拠した直感的で保守性の高いアーキテクチャを実現するための包括的な計画です。段階的アプローチにより、既存機能を保護しながら安全に移行を進めます。**
