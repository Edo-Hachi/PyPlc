# PyPlc Ver3 プロジェクト構成技術ノート

**作成日**: 2025-08-10  
**対象**: PyPlc Ver3 - PLC標準仕様完全準拠システム  
**目的**: プロジェクト全体のファイル構成・役割・責任範囲の整理

---

## 📋 **プロジェクト概要**

PyPlc Ver3は、PLC標準仕様に完全準拠したラダー図シミュレーターです。
Pyxelゲームエンジンを使用し、教育価値と実用性を両立した実装となっています。

### **主要機能**
- ラダー図エディター（接点・コイル・タイマー・カウンター・RST/ZRST）
- リアルタイム回路解析・電力フロー計算
- CSV保存・読み込み機能
- JSONスキーマベースのダイアログシステム
- PLC標準準拠デバイスID管理

---

## 🏗️ **プロジェクト構成**

```
PyPlc/
├── 🎯 **メインシステム** (Ver3現行版)
├── 📚 **DialogManager/** (高度ダイアログシステム)
├── 🔧 **core/** (システムコア機能)
├── 📋 **ドキュメント・設定ファイル**
├── 🗂️ **履歴・バックアップ** (Ver1/Ver2)
└── 🧪 **テスト・サンプルデータ**
```

---

## 🎯 **メインシステム (Ver3現行版)**

### **エントリーポイント**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `main.py` | **アプリケーション統合** | Pyxelアプリ初期化・メインループ・UI統合・イベント処理 |
| `config.py` | **システム設定統合** | 表示設定・グリッド設定・デバイス定義・UI設定・色定数 |

### **リソース・設定**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `sprites.json` | **スプライト定義** | デバイス描画用スプライト座標・サイズ情報 |
| `my_resource.pyxres` | **Pyxelリソース** | 画像・音声リソースファイル |
| `SpriteDefiner.py` | **スプライト管理ツール** | sprites.json生成・編集ツール |

### **データファイル (CSV)**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `*.csv` | **回路データ** | ラダー図保存・読み込み用CSVファイル |
| `StdCurcuit001.csv` | **標準回路サンプル** | 基本回路パターンの例 |
| `TimerTest.csv` | **タイマーテスト回路** | タイマー動作検証用 |
| `ZRST_Test_Circuit.csv` | **ZRSTテスト回路** | ZRST範囲リセット検証用 |

---

## 🔧 **core/ システムコア機能**

### **システム基盤**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `device_base.py` | **デバイス基底クラス** | PLCDevice基底・共通インターフェース・状態管理 |
| `grid_system.py` | **グリッドシステム** | 15行×20列グリッド管理・座標変換・デバイス配置 |
| `input_handler.py` | **入力処理** | マウス・キーボード入力・座標変換・スナップモード |

### **PLC機能**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `circuit_analyzer.py` | **回路解析エンジン** | ラダー図解析・電力フロー計算・タイマー/カウンター制御・RST処理 |
| `device_palette.py` | **デバイスパレット** | 1-0キー選択・マウス選択・デバイス切り替え・UI表示 |

### **データ管理**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `circuit_csv_manager.py` | **CSV入出力** | 回路データ保存・読み込み・フォーマット変換 |
| `SpriteManager.py` | **スプライト管理** | スプライト描画・アニメーション・リソース管理 |

### **ドキュメント**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `CircuitCsvFormat.md` | **CSVフォーマット仕様** | データフォーマット定義・例 |
| `_Sm400.md` | **技術ノート** | 実装詳細・仕様書 |

---

## 📚 **DialogManager/ 高度ダイアログシステム**

### **メインシステム**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `new_dialog_manager.py` | **ダイアログ統合管理** | ダイアログ生成・表示・結果処理の統合制御 |
| `new_file_dialog_manager.py` | **ファイルダイアログ管理** | ファイル選択・保存ダイアログの特化制御 |
| `json_dialog_loader.py` | **JSON定義ローダー** | JSON定義ファイル読み込み・パース・検証 |

### **専用ダイアログ**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `device_id_dialog_json.py` | **デバイスID編集** | デバイスアドレス編集・PLC標準バリデーション |
| `timer_counter_dialog_json.py` | **タイマー/カウンター設定** | プリセット値編集・範囲検証 |
| `file_load_dialog_json.py` | **ファイル読み込み** | CSVファイル選択・プレビュー |
| `file_save_dialog_json.py` | **ファイル保存** | CSVファイル保存・命名 |

### **基盤システム**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `base_dialog.py` | **ダイアログ基底** | 共通機能・描画基盤・状態管理 |
| `control_factory.py` | **コントロール生成** | UI部品ファクトリー・動的生成 |
| `schema_validator.py` | **JSONスキーマ検証** | 定義ファイル検証・エラー検出・品質保証 |

### **コントロール**
| ディレクトリ/ファイル | 役割 | 責任範囲 |
|-------------------|------|----------|
| `controls/` | **UI部品** | 個別UI部品の実装 |
| `controls/text_input_control.py` | **テキスト入力** | 文字入力・カーソル・バリデーション |
| `controls/file_list_control.py` | **ファイルリスト** | ファイル一覧・選択・フィルタリング |

### **イベントシステム**
| ディレクトリ/ファイル | 役割 | 責任範囲 |
|-------------------|------|----------|
| `events/` | **イベント処理** | ダイアログ間通信・イベント伝播 |
| `events/event_system.py` | **イベント管理** | イベント定義・ディスパッチ・ハンドリング |

### **バリデーション**
| ディレクトリ/ファイル | 役割 | 責任範囲 |
|-------------------|------|----------|
| `validation/` | **入力検証** | データ検証・エラー処理 |
| `validation/validator.py` | **検証エンジン** | 汎用検証・ルール適用・エラー報告 |

### **JSON定義・スキーマ**
| ディレクトリ/ファイル | 役割 | 責任範囲 |
|-------------------|------|----------|
| `definitions/` | **JSON定義** | ダイアログ定義・UI設定・データ構造 |
| `definitions/schemas/` | **JSONスキーマ** | 定義ファイル検証・VSCode統合・CI/CD |

#### **定義ファイル (definitions/)**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `device_settings.json` | **デバイス設定** | デバイスID編集ダイアログ定義 |
| `timer_settings.json` | **タイマー設定** | タイマー設定ダイアログ定義 |
| `counter_settings.json` | **カウンター設定** | カウンター設定ダイアログ定義 |
| `file_load_dialog.json` | **ファイル読み込み** | ファイル選択ダイアログ定義 |
| `file_save_dialog.json` | **ファイル保存** | ファイル保存ダイアログ定義 |

#### **スキーマファイル (definitions/schemas/)**
| ディレクトリ/ファイル | 役割 | 責任範囲 |
|-------------------|------|----------|
| `dialog_base_schema.json` | **基本ダイアログスキーマ** | 全ダイアログ共通構造定義 |
| `common/` | **共通定義** | 色・イベント・バリデーション共通定義 |
| `controls/` | **コントロールスキーマ** | UI部品毎のスキーマ定義 |
| `dialogs/` | **ダイアログスキーマ** | 個別ダイアログのスキーマ定義 |

### **テスト・統合**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `integration_test_dialog.py` | **統合テスト** | ダイアログシステム動作確認 |
| `phase2_integration_test.py` | **Phase2テスト** | 段階的機能テスト |
| `phase3_integration_test.py` | **Phase3テスト** | 最終統合テスト |
| `test_dialog_manager.py` | **単体テスト** | DialogManager動作テスト |

### **ドキュメント (DialogManager/Document/)**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `README.md` | **システム概要** | DialogManager全体説明 |
| `Architecture.md` | **アーキテクチャ** | 設計思想・構造説明 |
| `DeveloperGuide.md` | **開発ガイド** | 開発手順・拡張方法 |
| `EnvironmentSetup.md` | **環境設定** | 開発環境構築手順 |
| `EventSystem.md` | **イベントシステム** | イベント処理詳細 |
| `FileListControl.md` | **ファイルリスト** | ファイルリスト機能説明 |
| `JSONDefinition.md` | **JSON定義** | 定義ファイル作成方法 |

---

## 📋 **ドキュメント・設定ファイル**

### **プロジェクトドキュメント**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `CLAUDE.md` | **開発記録** | Ver3開発履歴・進捗・技術的決定事項 |
| `README.md` | **プロジェクト説明** | 概要・使用方法・要件 |
| `GEMINI.md` | **Gemini分析記録** | AI分析結果・改善提案記録 |

### **技術ノート**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `_Common_Report.md` | **共通レポート** | 技術的分析・課題・解決策 |
| `_PLC_RESET.md` | **RST実装資料** | RST/ZRST機能の調査・設計 |
| `_Cursor_Add_RsetDev.md` | **カーソル機能** | UI機能改善記録 |

### **開発環境設定**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `.vscode/settings.json` | **VSCode設定** | エディター設定・JSONスキーマ統合 |
| `.vscode/launch.json` | **デバッグ設定** | Python実行・デバッグ設定 |
| `.claude/` | **Claude設定** | Claude Code設定・プロジェクト固有設定 |

### **品質保証**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `validate_definitions.py` | **JSON検証ツール** | 定義ファイル自動検証・CI/CD対応 |
| `validation_report.txt` | **検証レポート** | 検証結果・エラー報告 |

---

## 🗂️ **履歴・バックアップ (Ver1/Ver2)**

### **Project Ver01/ (プロトタイプ版)**
- **役割**: 初期プロトタイプ・アイデア検証
- **状態**: アーカイブ済み（参考用）
- **特徴**: 基本概念実装・座標系問題

### **Project Ver02/ (安定版)**
- **役割**: モジュール化・機能拡張版
- **状態**: アーカイブ済み（資産活用）
- **特徴**: デバイスパレット・60FPS動作・Ver3設計参考

### **過去資産活用**
| ディレクトリ | 活用箇所 | 活用内容 |
|------------|----------|----------|
| `Project Ver02/core/placement_system.py` | `core/device_palette.py` | デバイス選択システム設計参考 |
| `Project Ver02/core/input_handler.py` | `core/input_handler.py` | マウス入力最適化手法 |

---

## 🧪 **テスト・サンプルデータ**

### **回路データ**
| ファイル | 役割 | 責任範囲 |
|---------|------|----------|
| `My_Curcuit_TIMER_RST.csv` | **タイマー/RSTテスト** | 実動作検証用回路 |
| `StdCurcuit001.csv` | **標準回路** | 基本パターン例 |
| `TimerTest.csv` | **タイマーテスト** | タイマー機能検証 |
| `ZRST_Test_Circuit.csv` | **ZRSTテスト** | 範囲リセット検証 |

### **開発支援**
| ディレクトリ/ファイル | 役割 | 責任範囲 |
|-------------------|------|----------|
| `New_Docs/` | **要件・仕様書** | 機能要件・設計仕様・計画書 |
| `SupportAgent/` | **AI支援** | AI開発支援記録・レビュー結果 |
| `_ProjectReportMd/` | **プロジェクトレポート** | 開発レポート・進捗記録 |

### **廃止システム**
| ディレクトリ/ファイル | 役割 | 状態 |
|-------------------|------|------|
| `dialogs_old_system/` | **旧ダイアログ** | 廃止済み（DialogManagerに移行完了） |

---

## 🎯 **アーキテクチャ特徴**

### **責任分離設計**
- **main.py**: 統合・調整役
- **core/**: システム基盤・PLC機能
- **DialogManager/**: UI・ダイアログ機能
- **config.py**: 設定・定数統合

### **品質保証**
- **JSONスキーマ**: VSCode統合・自動検証
- **型ヒント**: 100%型安全性
- **モジュール分離**: 保守性・テスト容易性

### **PLC標準準拠**
- **三菱PLC準拠**: 実機同等動作
- **教育価値**: 実PLC移行容易性
- **WindSurf A+評価**: 商用レベル品質

### **拡張性**
- **JSONベース定義**: 新機能追加容易
- **モジュラー設計**: 独立性・再利用性
- **スキーマ検証**: 品質自動保証

---

## 📊 **開発統計**

### **コードベース規模**
- **総ファイル数**: 約100+ファイル
- **Python実装**: 約50ファイル
- **JSON定義**: 約20ファイル
- **ドキュメント**: 約30ファイル

### **実装完成度**
- ✅ **Phase 1-5**: 基本システム完全実装
- ✅ **タイマー・カウンター**: PLC標準完全準拠
- ✅ **RST/ZRST**: 範囲リセット対応
- ✅ **JSONスキーマ**: VSCode統合完了
- ✅ **品質評価**: WindSurf A+評価獲得

---

**最終更新**: 2025-08-10  
**作成者**: Claude Code Assistant  
**プロジェクト**: PyPlc Ver3 - PLC標準仕様完全準拠システム