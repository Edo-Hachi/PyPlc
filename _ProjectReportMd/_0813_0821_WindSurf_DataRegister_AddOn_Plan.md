# PyPlc データレジスタ（Dデバイス）実装プラン

## 1. 概要
PLC標準機能としてデータレジスタ（Dデバイス）を実装する。データレジスタは数値データを保持する16ビットのメモリ領域で、タイマー/カウンタの設定値や演算結果の保持などに使用される。

## 2. 実装範囲

### 2.1 基本仕様
- アドレス範囲: D0 ～ D7999（16ビット符号付き整数: -32,768 ～ 32,767）
- 初期値: 0
- データ型: 16ビット符号付き整数（int16）
- アクセス方法: 直接参照・MOV命令による読み書き

### 2.2 実装対象機能
1. データレジスタの基本機能
   - 値の読み書き
   - 初期化
   - 範囲チェック

2. 基本命令セット（フェーズ1）
   - MOV (Move)
   - ADD (Addition)
   - SUB (Subtraction)
   - CMP (Compare)
   - AND/OR/XOR (ビット演算)

3. UI対応
   - デバイス一覧への表示
   - 値の監視・編集機能
   - データレジスタビューアの追加

## 3. 実装手順

### フェーズ1: 基本機能の実装

1. **デバイスタイプの追加**
   - `config.py`の`DeviceType`に`DATA_REGISTER`を追加
   - `DeviceAddressRanges`クラスにDデバイスの範囲を定義（既存）

2. **データレジスタ管理クラスの作成**
   ```python
   # core/data_register.py
   class DataRegisterManager:
       def __init__(self):
           self.registers = {}  # D0-D7999の辞書
           self.initialize_registers()
           
       def initialize_registers(self):
           # D0-D7999を0で初期化
           pass
           
       def get_value(self, address: str) -> int:
           # アドレスチェックと値取得
           pass
           
       def set_value(self, address: str, value: int) -> bool:
           # 範囲チェックと値設定
           pass
   ```

3. **回路解析エンジンへの統合**
   - `CircuitAnalyzer`クラスにデータレジスタマネージャーを追加
   - 命令実行メソッドの追加

### フェーズ2: 命令セットの実装

1. **基本命令の実装**
   - MOV命令: レジスタ間、即値の転送
   - 算術演算: ADD, SUB, MUL, DIV
   - 論理演算: AND, OR, XOR, NOT
   - 比較演算: CMP, GT, LT, EQ, NEQ

2. **命令実行エンジンの拡張**
   ```python
   class InstructionExecutor:
       def __init__(self, register_manager):
           self.registers = register_manager
           
       def execute(self, instruction):
           # 命令のデコードと実行
           pass
   ```

### フェーズ3: UI統合

1. **データレジスタビューア**
   - メイン画面にデータレジスタ表示エリアを追加
   - スクロール可能なテーブル表示
   - 値の直接編集機能

2. **デバイスパレットの拡張**
   - データレジスタ操作命令の追加
   - コンテキストメニューからのアクセス

## 4. 技術的課題と解決策

### 4.1 パフォーマンス
- **課題**: 8000個のレジスタを効率的に管理
- **解決策**: 疎な辞書型を使用し、実際に使用されているレジスタのみをメモリに保持

### 4.2 命令セットの拡張性
- **課題**: 将来の命令追加を容易にする設計
- **解決策**: 命令をクラス階層で実装し、新しい命令の追加を容易に

### 4.3 マルチスレッド対応
- **課題**: スレッドセーフな実装
- **解決策**: スレッドローカルストレージの使用または適切なロック機構の導入

## 5. テスト計画

### 5.1 単体テスト
- データレジスタの基本操作（読み書き）
- 各命令の動作確認
- 境界値テスト（オーバーフロー/アンダーフロー）

### 5.2 統合テスト
- タイマー/カウンタとの連携
- 複合的なラダー論理との組み合わせ
- 負荷テスト（大量のレジスタ操作）

## 6. 今後の拡張案

### 6.1 フェーズ2以降の機能
- 浮動小数点演算のサポート
- インデックスレジスタ（Z, V）のサポート
- ファイル入出力によるレジスタ状態の保存・復元

### 6.2 デバッグ機能
- データレジスタのウォッチ機能
- ブレークポイント設定
- 実行トレース

## 7. 実装スケジュール（見積もり）

| フェーズ | 内容 | 期間 |
|---------|------|------|
| 1 | 基本機能 | 1週間 |
| 2 | 命令セット | 2週間 |
| 3 | UI統合 | 1週間 |
| 4 | テスト・デバッグ | 1週間 |

## 8. リスク管理

| リスク | 影響度 | 対応策 |
|-------|--------|--------|
| パフォーマンス低下 | 高 | プロファイリングを行い、ボトルネックを特定・最適化 |
| 既存機能への影響 | 中 | 段階的な実装と包括的なリグレッションテスト |
| メモリ使用量の増加 | 低 | 疎なデータ構造の採用とメモリ使用量のモニタリング |

## 9. 参考資料
- 三菱電機 PLC プログラミングマニュアル
- IEC 61131-3 プログラマブルコントローラ プログラミング言語
- 既存のPyPlc実装コードベース
