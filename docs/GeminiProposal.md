# Gemini Proposal: PyPlc Electrical System Analysis and Redesign Plan

## 1. 現在の問題点 (Current Issues)

現在、PyPlcシミュレーターの電気系統において、以下の問題が確認されています。

### 1.1. コイル以降への電力不伝播
- **現象**: X接点やワイヤーを通じてコイル（`INCOIL`, `COIL`など）まで電力が到達し、コイル自体は通電状態を示すものの、コイルの右隣に配置されたワイヤーや他のデバイスへ電力が伝播しない。
- **ログ分析からの示唆**: `electrical_system.py`の`LadderRung.calculate_power_flow`メソッド内で、コイルデバイスを処理した後に`power`変数が意図せず`False`に設定されている、または、コイルが電力の流れを「消費」するデバイスとして扱われ、その後の電力伝播が停止している。直近の修正で`power = False`の直接的な代入は削除されたが、依然として同様の挙動が見られる。これは、コイルが電力の流れを遮断する「負荷」として機能しているため、その後の電力伝播が停止している可能性が高い。

### 1.2. `calculate_power_flow`ロジックの複雑性
- `calculate_power_flow`メソッドは、各グリッドセルを左から右へ順に走査し、デバイスの種類に応じて`power`変数を更新するロジックを採用している。
- このアプローチは、デバイスが電力の流れを「通過させる」か「遮断する」かをその場で決定するため、コイルのような「電力を消費するが、流れは遮断しない」デバイスの挙動を正確にモデル化するのが難しい。
- 特に、`else`ブロックで未定義のデバイスが電力を遮断する挙動は、意図しない電力停止の原因となる。

## 2. 改善点 (Proposed Improvements - Immediate Next Steps)

現在の電力不伝播問題を解決するため、`electrical_system.py`の`LadderRung.calculate_power_flow`メソッドのロジックをさらに洗練させる必要があります。

### 2.1. `calculate_power_flow`ロジックの再考
- **原則**: `power`変数は、現在のデバイスが「電力を通過させるかどうか」によってのみ更新されるべきであり、「電力を消費する」デバイス（コイル、タイマーなど）によって`False`に設定されるべきではない。
- **修正方針**:
    1.  `power`変数の初期化は、ラングの左端（HOTバス）からの電力状態に依存する。
    2.  各デバイスの処理において、`power`変数は以下のルールで更新されるべき。
        *   **ワイヤー (`WIRE_H`)**: `power`の状態をそのまま維持する。
        *   **A接点 (`TYPE_A`)**: `power`が`True` **かつ** `contact_state`が`True`の場合のみ`power`を`True`に維持。それ以外は`False`。
        *   **B接点 (`TYPE_B`)**: `power`が`True` **かつ** `contact_state`が`False`の場合のみ`power`を`True`に維持。それ以外は`False`。
        *   **コイル (`COIL`, `INCOIL`, `OUTCOIL_REV`)**: `power`の状態をそのまま維持する。コイル自身の`coil_energized`状態は、`power`が`True`であれば`True`に設定されるが、`power`変数を`False`に上書きしない。
        *   **タイマー (`TIMER`)**: `power`の状態をそのまま維持する。タイマー自身のロジック（カウントアップ、ON/OFF）は`_process_timer_logic`で処理されるが、`power`変数を`False`に上書きしない。
        *   **カウンター (`COUNTER`)**: `power`の状態をそのまま維持する。カウンター自身のロジックは`_process_counter_logic`で処理されるが、`power`変数を`False`に上書きしない。
        *   **その他のデバイス (`LINK_UP`, `LINK_DOWN`, `DEL`, `EMPTY`など)**: これらのデバイスは、電力の流れを遮断しない。`power`の状態をそのまま維持する。

### 2.2. デバッグログの強化
- 上記の修正後も問題が解決しない場合、各デバイスの`active`状態や`coil_energized`状態が、`calculate_power_flow`の外部で意図せず変更されていないかを確認するため、関連するメソッド（例: `ElectricalSystem.synchronize_coil_to_device`）にもデバッグログを追加する。

## 3. 再設計プラン (Redesign Plan - Long-Term Vision)

現在の`calculate_power_flow`メソッドは、PLCの基本的なラダーロジックをシミュレートするには十分ですが、より複雑な回路（並列分岐、自己保持回路の多段化など）や、将来的な機能拡張（ネットワーク化されたPLC、異なる種類のバスラインなど）に対応するためには、より堅牢でスケーラブルな電気系統の再設計が必要です。

`CLAUDE.md`で言及されている「**完全回路継続性管理 (CircuitTopologyManager)**」の導入が、この再設計の核となるでしょう。

### 3.1. アーキテクチャの変更: トポロジーベースの電力計算

- **現状の課題**: 現在の`calculate_power_flow`は、グリッドの各セルを順に走査する線形的なアプローチ。これにより、並列パスや複雑な分岐の正確な電力計算が困難。
- **再設計の提案**:
    1.  **回路グラフの構築**: `GridDeviceManager`が管理するグリッド上のデバイスと明示的なワイヤー（`WIRE_H`, `WIRE_V`）をノードとし、それらの間の電気的接続をエッジとする「回路グラフ」を構築する。
        *   各デバイスは、その種類に応じて「導通条件」（例: A接点は`contact_state`が`True`かつ入力が`True`）を持つ。
        *   ワイヤーは常に導通するエッジとして機能する。
    2.  **電力伝播アルゴリズム**: 構築された回路グラフ上で、HOTバス（電源）を起点として、導通条件を満たすエッジをたどるグラフ探索アルゴリズム（例: 幅優先探索 (BFS) や深さ優先探索 (DFS)）を実行する。
        *   探索中に到達したノード（デバイス）は「通電状態」とマークされる。
        *   コイルやタイマーなどの負荷デバイスは、通電状態になった場合に自身の内部状態を更新するが、電力伝播自体は遮断しない。
    3.  **状態の同期**: グラフ探索の結果に基づいて、各`GridDevice`の`active`状態や`wire_energized`状態を更新する。

### 3.2. 主要な改善点とメリット

-   **正確な電力計算**: 並列パスや複雑な分岐を含むあらゆるラダー回路の電力フローを正確にシミュレートできる。
-   **自己保持回路の堅牢性**: グラフベースのアプローチにより、自己保持回路のフィードバックループを自然に処理できる。
-   **モジュール性の向上**:
    *   `GridDeviceManager`: グリッド上のデバイス配置と接続情報の管理に特化。
    *   `ElectricalSystem` (または新しい`CircuitTopologyManager`): 回路グラフの構築と電力伝播アルゴリズムの実行に特化。
    *   各`GridDevice`: 自身の導通条件と状態更新ロジックに特化。
-   **拡張性**: 将来的に新しいデバイスタイプや複雑なロジック（例: アナログ値、PID制御）を追加する際に、既存の電力伝播アルゴリズムに大きな変更を加えることなく対応できる。
-   **デバッグの容易性**: 回路グラフを可視化することで、電力の流れや問題箇所を直感的に把握できる。

### 3.3. 実装ステップ (概要)

1.  **`CircuitTopologyManager`の本格導入**: `electrical_system.py`内の`use_topology_system`フラグを`True`にし、既存の`CircuitTopologyManager`クラスを拡張する。
2.  **回路グラフの定義**: ノード（デバイス）とエッジ（接続）を表現するデータ構造を定義する。
3.  **グラフ構築ロジック**: `GridDeviceManager`からグリッド情報を取得し、回路グラフを動的に構築するメソッドを実装する。
4.  **電力伝播アルゴリズム**: 構築されたグラフ上で電力伝播をシミュレートするアルゴリズムを実装する。
5.  **既存システムとの統合**: `main.py`の`_update_systems`から新しいトポロジーベースの電力計算を呼び出すように変更する。
6.  **テストと検証**: 既存のテスト回路に加え、特に並列回路や複雑な自己保持回路で徹底的なテストを行う。

この再設計は大きな変更を伴いますが、PyPlcシミュレーターの長期的な安定性と機能拡張性にとって不可欠であると考えます。